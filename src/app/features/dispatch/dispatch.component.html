<div id="content">
    <div class="header">
        <sa-big-breadcrumbs [items]="['Dispatch']" icon="taxi">
        </sa-big-breadcrumbs>
        <div class="right-content">
            <ng-select [items]="dispatchGroups" [(ngModel)]="dispatchGroupId" (change)="changeDispatchGroup()"
                bindValue="id" bindLabel="name" class="filter-select" placeholder="Dispatch Group">
            </ng-select>
            <span>Bookings</span><switch [checked]="visibleBookings" (changed)="showBookings($event)"></switch>
        </div>
    </div>
    <div class="row">
        <div class="col-sm-12 col-md-12 col-lg-12">
            <div class="nav nav-tabs trips-left-tabs">
                <li [class.active]="tripsTab === 'Plan'" style="width: 100%;">
                    <a (click)="tripsTab !== 'Plan' && showPlan()">
                        <span><i class="fa fa-circle" style="color: orange;"></i>&nbsp;Plan</span>
                    </a>
                </li>
                <li [class.active]="tripsTab === 'Current'" style="width: 100%;">
                    <a (click)="tripsTab !== 'Current' && showCurrent()">
                        <span><i class="fa fa-circle" style="color: green;"></i>&nbsp;Current</span>
                    </a>
                </li>
                <li [class.active]="tripsTab === 'Complete'" style="width: 100%;">
                    <a (click)="tripsTab !== 'Complete' && showComplete()">
                        <span><i class="fa fa-circle" style="color: gray;"></i>&nbsp;Complete</span>
                    </a>
                </li>
            </div>

            <div class="panel panel-default trips-content">
                <!-- Trips Table -->
                <div class="panel-heading" droppable (onDrop)="onBookingDrop(null, $event)"
                    [dropScope]="'booking'" [dropEnabled]="tripsTab === 'Plan'">
                    <ul class="nav nav-tabs">
                        <li [class.active]="entityType === entityTypes.VEHICLE">
                            <a (click)="entityType !== entityTypes.VEHICLE && showVehicle()">
                                <span><i class="fa fa-truck"></i>&nbsp;Vehicles</span>
                            </a>
                        </li>
                        <li [class.active]="entityType === entityTypes.DRIVER">
                            <a (click)="entityType !== entityTypes.DRIVER && showDriver()">
                                <span><i class="fa fa-user"></i>&nbsp;Drivers</span>
                            </a>
                        </li>
                    </ul>

                    <div class="btn-group">
                        <input class="panel-search" placeholder="Search..." name="searchTrips" id="searchTrips"
                            [(ngModel)]="tSearch" type="text">
                        <span class="fa fa-times message-search-clear" (click)="tSearch = ''"></span>
                    </div>

                    <!-- <a class="action-link" (click)="addTrip(addTripModal)" *ngIf="typesLoaded && customersLoaded">
                        New Trip
                    </a> -->
                </div>

                <div class="panel-body no-padding" *ngVar="{
                    filteredItems: items | tripsHandlerItemSearch:tSearch,
                    paginatedItems: items | tripsHandlerItemSearch:tSearch | arrayPagination:tripsPage:(visibleBookings ? tripsPageSize : tableLength)
                } as itemsFilter">
                    <table *ngIf="tableTripsColumns.length > 0" class="responsive table table-bordered table-hover">
                        <thead>
                            <tr>
                                <th *ngIf="getTripsColumnVisible(0)" class="col-sm-1">{{getEntityName()}}</th>
                                <th *ngIf="getTripsColumnVisible(1)" class="text-center col-sm-1">Stops</th>
                                <th *ngIf="getTripsColumnVisible(2)" class="col-1_6">Trip&nbsp;No</th>
                                <th *ngIf="getTripsColumnVisible(3)" class="col-sm-1">Status</th>
                                <th *ngIf="getTripsColumnVisible(4)" class="col-sm-2">Origin</th>
                                <th *ngIf="getTripsColumnVisible(5)" class="col-1_7">Load Date</th>
                                <th *ngIf="getTripsColumnVisible(6)" class="col-sm-2">Destination</th>
                                <th *ngIf="getTripsColumnVisible(7)" class="col-1_7">Delv Date</th>
                            </tr>
                        </thead>
                        <tbody *ngIf="!itemsFilter.paginatedItems.array || itemsFilter.paginatedItems.array.length === 0">
                            <tr>
                                <td class="trips-notrips" colspan="8">
                                    No trips
                                </td>
                            </tr>
                        </tbody>
                        <ng-container *ngIf="!!itemsFilter.paginatedItems.array && itemsFilter.paginatedItems.array.length > 0">
                            <tbody *ngFor="let item of itemsFilter.paginatedItems.array" droppable (onDrop)="onBookingDrop(item, $event)"
                                [dropScope]="'booking'" [dropEnabled]="tripsTab === 'Plan'">
                                <ng-container *ngFor="let trip of item.trips; let i = index">
                                    <tr [class.success]="trip.status === tripStatuses.PREASSIGNED"
                                        droppable (onDrop)="onTripReorder(entityType, trip, item.getEntity(), item.trips, $event)" [dropScope]="'reassign' + item.getEntity().id"
                                        [dropEnabled]="trip.status === tripStatuses.PREASSIGNED"
                                        [dragEnabled]="trip.status === tripStatuses.PREASSIGNED"
                                        draggable [dragData]="{trip: trip, entity: item.getEntity()}" [dragScope]="['trip', 'reassign' + item.getEntity().id]" [dragEnabled]="trip.status === tripStatuses.PREASSIGNED">
                                        <td class="col-sm-1" *ngIf="getTripsColumnVisible(0)"
                                            droppable [dropScope]="'trip'"
                                            [dropEnabled]="tripsTab === 'Plan' && i === 0"
                                            (onDrop)="onTripReassign(entityType, item.getEntity(), $event)">
                                            <ng-container *ngIf="i === 0">
                                                <ng-container *ngIf="entityType === entityTypes.VEHICLE">
                                                    <app-vehicle-map-modal [vehicle]="item.vehicle" [highlight]="tSearch"></app-vehicle-map-modal>
                                                </ng-container>
                                                <ng-container *ngIf="entityType === entityTypes.DRIVER">
                                                    <a *ngIf="entityType === entityTypes.DRIVER" href="#/drivers/{{item.driver.id}}/view">
                                                        <span ngxTextHighlight [content]="item.driver.name() + ' (' + (item.driver.remoteId || '(unspecified)') + ')'" [searchTerm]="tSearch"  [caseSensitive]="false">
                                                        </span>
                                                    </a>
                                                </ng-container>
                                            </ng-container>
                                        </td>
                                        <td class="text-center col-sm-1" *ngIf="getTripsColumnVisible(1)">
                                            <a (click)="tripsCollapseMap[item.getEntity().id + '.' + trip.id] =
                                                        !tripsCollapseMap[item.getEntity().id + '.' + trip.id]"
                                                class="button-icon">
                                                <i class="fa"
                                                    [class.fa-plus]="!tripsCollapseMap[item.getEntity().id + '.' + trip.id]"
                                                    [class.fa-minus]="tripsCollapseMap[item.getEntity().id + '.' + trip.id]">
                                                </i>
                                            </a>
                                        </td>
                                        <td class="col-1_6" *ngIf="getTripsColumnVisible(2)">
                                            <span ngxTextHighlight [content]="trip.tripNo" [searchTerm]="tSearch"  [caseSensitive]="false">
                                            </span>
                                            <app-trip-audit-modal *ngIf="connectionsLoaded" [trip]="trip" [connections]="connections" [drivers]="drivers">
                                            </app-trip-audit-modal>
                                            <a (click)="editTrip(trip)" style="margin-left: 3px;" *ngIf="!trip.connectionBindList || trip.connectionBindList.length === 0">
                                                <i class="fa fa-pencil"></i>
                                            </a>
                                            <i class="fa fa-tablet" style="margin-left: 3px;"
                                                [style.color]="trip.acknowledgedByMobile ? 'green' : 'red'"
                                                [attr.title]="trip.acknowledgedByMobile ? 'Acknowledged' : 'Not Acknowledged'">
                                            </i>
                                        </td>
                                        <td class="col-sm-1" *ngIf="getTripsColumnVisible(3)">
                                            <span ngxTextHighlight [content]="trip.status | titlecase" [searchTerm]="tSearch"  [caseSensitive]="false">
                                            </span>
                                        </td>
                                        <td class="col-sm-2" *ngIf="getTripsColumnVisible(4)">
                                            <ng-container *ngTemplateOutlet="stopLocation; context: {
                                                stop: trip.getFirstStop([stopTypesEnum.PICKUP, stopTypesEnum.PICKUP_DOCK, stopTypesEnum.TRAILER_POSITION, stopTypesEnum.TRACTOR_POSITION]),
                                                query: tSearch
                                            }"></ng-container>
                                        </td>
                                        <td class="col-1_7" *ngIf="getTripsColumnVisible(5)">
                                            <ng-container *ngTemplateOutlet="stopDate; context: {
                                                stop: trip.getFirstStop([stopTypesEnum.PICKUP, stopTypesEnum.PICKUP_DOCK, stopTypesEnum.TRAILER_POSITION, stopTypesEnum.TRACTOR_POSITION]),
                                                key: 'appointmentFrom'
                                            }"></ng-container>
                                        </td>
                                        <td class="col-sm-2" *ngIf="getTripsColumnVisible(6)">
                                            <ng-container *ngTemplateOutlet="stopLocation; context: {
                                                stop: trip.getLastStop([stopTypesEnum.DROP, stopTypesEnum.DROP_DOCK, stopTypesEnum.TRAILER_POSITION, stopTypesEnum.TRACTOR_POSITION]),
                                                query: tSearch
                                            }"></ng-container>
                                        </td>
                                        <td class="col-1_7" *ngIf="getTripsColumnVisible(7)">
                                            <ng-container *ngTemplateOutlet="stopDate; context: {
                                                stop: trip.getLastStop([stopTypesEnum.DROP, stopTypesEnum.DROP_DOCK, stopTypesEnum.TRAILER_POSITION, stopTypesEnum.TRACTOR_POSITION]),
                                                key: 'appointmentFrom'
                                            }"></ng-container>
                                        </td>
                                    </tr>

                                    <ng-container *ngIf="tripsCollapseMap[item.getEntity().id + '.' + trip.id]">
                                        <ng-container *ngTemplateOutlet="stopsSubtable; context: {
                                            stops: trip.stops,
                                            dispatched: trip.status === tripStatuses.DISPATCHED,
                                            preassigned: trip.status === tripStatuses.PREASSIGNED,
                                            leftColspan: 2, totalColspan: 8,
                                            entityId: item.getEntity().id + '.' + trip.id,
                                            collapseMap: tripsCollapseMap,
                                            driver: item.driver || firstDriver(trip)
                                        }"></ng-container>
                                    </ng-container>
                                </ng-container>
                            </tbody>
                        </ng-container>
                    </table>
                    <div class="dt-toolbar-footer">
                        <div class="col-sm-6 col-xs-12 hidden-xs">
                            <div class="dataTables_info" role="status" style="padding-top: 9px; padding-bottom: 6px;">
                                Showing {{itemsFilter.filteredItems.length > 0 ? itemsFilter.paginatedItems.begin + 1 : 0}}
                                to {{itemsFilter.paginatedItems.end}} of {{itemsFilter.filteredItems.length}} {{entityType === entityTypes.VEHICLE ? 'vehicles' : 'drivers'}}
                            </div>
                        </div>
                        <div class="col-xs-12 col-sm-6" style="padding-top: 2px;">
                            <ngb-pagination [boundaryLinks]="false" [collectionSize]="itemsFilter.filteredItems.length" [(page)]="tripsPage"
                                [pageSize]="visibleBookings ? tripsPageSize : tableLength" [maxSize]="4" [rotate]="true" [ellipses]="true" size="sm"
                                (pageChange)="changeTripsPage($event)" aria-label="Default pagination" *ngIf="itemsFilter.filteredItems.length > 0"
                                class="pagination-no-margin">
                                <ng-template ngbPaginationPrevious>
                                    Previous
                                </ng-template>
                                <ng-template ngbPaginationNext>
                                    Next
                                </ng-template>
                            </ngb-pagination>
                            <div class="column-selector-menu-show-hide hidden-xs">
                                <a id="tripsContextShowHide" class="action-link" title="Manage Columns">
                                    Manage Columns
                                </a>
                            </div>
                        </div>
                    </div>

                    <div id="columnSelectorContextTrips" #columnSelectorContextTrips class="column-selector-menu"
                        [style.left.px]="columnSelectorTripsMenuLeft" [style.top.px]="columnSelectorTripsMenuTop"
                        *ngIf="showColumnSelectorTrips" >
                        <div class="column-selector-menu-options">
                            <span>Select Columns</span>
                            <br>
                            <ng-container *ngFor="let tableColumn of tableTripsColumnsClone">
                                <input type="checkbox" name="list" (change)="columnSelectionChange(tableNameTrips, tableTripsColumnsClone, tableColumn)" data-target="1"
                                    [value]="tableColumn.index" [checked]="tableColumn.visible" class="column-selector-menu-option"
                                    [disabled]="isLastColumnTrips && tableColumn.visible">
                                {{getName(tableColumn.name)}}
                                <br>
                            </ng-container>
                            <button class="btn btn-default pull-right column-select-button"
                                (click)="applyColumnSelection(tableNameTrips, tableTripsColumnsClone)">
                                Apply
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bookings Table -->
    <div *ngIf="visibleBookings" class="row">
        <div class="col-sm-12 col-md-12 col-lg-12">
            <div class="panel panel-default">
                <div class="panel-heading" droppable (onDrop)="onTripDrop($event)" [dropScope]="'trip'">
                    <ul class="nav nav-tabs">
                        <li [class.active]="status === statuses.AVAILABLE">
                            <a (click)="status !== statuses.AVAILABLE && showAvailable()">
                                <span><i class="fa fa-tags"></i>&nbsp;Available</span>
                            </a>
                        </li>
                        <li [class.active]="status === statuses.DISPATCHED">
                            <a (click)="status !== statuses.DISPATCHED && showDispatched()">
                                <span><i class="fa fa-spinner" style="color: orange;"></i>&nbsp;Dispatched</span>
                            </a>
                        </li>
                        <li [class.active]="status === statuses.COMPLETED">
                            <a (click)="status !== statuses.COMPLETED && showCompleted()">
                                <span><i class="fa fa-check-circle-o" style="color: green;"></i>&nbsp;Completed</span>
                            </a>
                        </li>
                    </ul>

                    <div class="btn-group">
                        <input class="panel-search" placeholder="Search..." name="searchBookings" id="searchBookings"
                            [(ngModel)]="bSearch" type="text">
                        <span class="fa fa-times message-search-clear" (click)="bSearch = ''"></span>
                    </div>

                    <div class="spacer"></div>

                    <app-create-booking [linkName]="'New Booking'" (callback)="refreshBookingsTable()"
                        [customers]="customers" [types]="types" [feedbackTypes]="feedbackTypes" [locations]="locations"
                        *ngIf="typesLoaded && customersLoaded">
                    </app-create-booking>
                </div>

                <div class="panel-body no-padding" *ngVar="{
                    filteredBookings: bookings | bookingSearch:bSearch,
                    paginatedBookings: bookings | bookingSearch:bSearch | arrayPagination:bookingsPage:bookingsPageSize
                } as bookingsFilter">
                    <table *ngIf="tableBookingsColumns.length > 0" class="responsive table table-bordered table-hover">
                        <thead>
                            <tr>
                                <th *ngIf="getBookingsColumnVisible(0)" class="text-center col-sm-1">Stops</th>
                                <th *ngIf="getBookingsColumnVisible(1)" class="col-sm-1">Book&nbsp;No</th>
                                <th *ngIf="getBookingsColumnVisible(2)" class="col-1_5">Customer</th>
                                <th *ngIf="getBookingsColumnVisible(3)" class="col-1_5">Origin</th>
                                <th *ngIf="getBookingsColumnVisible(4)" class="col-1_5">Load Date</th>
                                <th *ngIf="getBookingsColumnVisible(5)" class="col-1_5">Load No</th>
                                <th *ngIf="getBookingsColumnVisible(6)" class="col-sm-2">Destination</th>
                                <th *ngIf="getBookingsColumnVisible(7)" class="col-sm-1">Delv Date</th>
                                <th *ngIf="getBookingsColumnVisible(8)" class="col-sm-1">Vehicle&nbsp;Type</th>
                            </tr>
                        </thead>
                        <tbody *ngIf="!bookingsFilter.paginatedBookings.array || bookingsFilter.paginatedBookings.array.length === 0">
                            <tr>
                                <td colspan="10" style="text-align: center; vertical-align: middle;">
                                    No bookings
                                </td>
                            </tr>
                        </tbody>
                        <tbody *ngIf="!!bookingsFilter.paginatedBookings.array && bookingsFilter.paginatedBookings.array.length > 0">
                            <ng-container *ngFor="let booking of bookingsFilter.paginatedBookings.array">
                                <tr draggable [dragData]="booking" [dragScope]="'booking'"
                                    [dragEnabled]="booking.status === statuses.AVAILABLE && vehiclesLoaded && driversLoaded">
                                    <td *ngIf="getBookingsColumnVisible(0)" class="text-center col-sm-1">
                                        <a (click)="bookingsCollapseMap[booking.id] = !bookingsCollapseMap[booking.id]"
                                            class="button-icon">
                                            <i class="fa"
                                                [class.fa-plus]="!bookingsCollapseMap[booking.id]"
                                                [class.fa-minus]="bookingsCollapseMap[booking.id]">
                                            </i>
                                        </a>
                                    </td>
                                    <td *ngIf="getBookingsColumnVisible(1)" class="col-sm-1">
                                        <a href="#/bookings/{{booking.id}}/view">
                                            <span ngxTextHighlight [content]="booking.bookNo" [searchTerm]="bSearch"  [caseSensitive]="false">
                                            </span>
                                        </a>
                                    </td>
                                    <td *ngIf="getBookingsColumnVisible(2)" class="col-sm-1">
                                        <a href="#/customers/{{booking.customer.id}}/view">
                                            <span ngxTextHighlight [content]="booking.customer.name" [searchTerm]="bSearch"  [caseSensitive]="false">
                                            </span>
                                        </a>
                                    </td>
                                    <td *ngIf="getBookingsColumnVisible(3)" class="col-sm-2">
                                        <ng-container *ngTemplateOutlet="stopLocation; context: {
                                            stop: booking.getFirstStop([stopTypesEnum.PICKUP, stopTypesEnum.PICKUP_DOCK, stopTypesEnum.TRAILER_POSITION, stopTypesEnum.TRACTOR_POSITION]),
                                            query: bSearch
                                        }"></ng-container>
                                    </td>
                                    <td *ngIf="getBookingsColumnVisible(4)" class="col-sm-1">
                                        <ng-container *ngTemplateOutlet="stopDate; context: {
                                            stop: booking.getFirstStop([stopTypesEnum.PICKUP, stopTypesEnum.PICKUP_DOCK, stopTypesEnum.TRAILER_POSITION, stopTypesEnum.TRACTOR_POSITION]),
                                            key: 'appointmentFrom'
                                        }"></ng-container>
                                    </td>
                                    <td *ngIf="getBookingsColumnVisible(5)" class="col-sm-1">
                                        <ng-container>{{booking.bolNo}}</ng-container>
                                    </td>
                                    <td *ngIf="getBookingsColumnVisible(6)" class="col-sm-2">
                                        <ng-container *ngTemplateOutlet="stopLocation; context: {
                                            stop: booking.getLastStop([stopTypesEnum.DROP, stopTypesEnum.DROP_DOCK, stopTypesEnum.TRAILER_POSITION, stopTypesEnum.TRACTOR_POSITION]),
                                            query: bSearch
                                        }"></ng-container>
                                    </td>
                                    <td *ngIf="getBookingsColumnVisible(7)" class="col-sm-1">
                                        <ng-container *ngTemplateOutlet="stopDate; context: {
                                            stop: booking.getLastStop([stopTypesEnum.DROP, stopTypesEnum.DROP_DOCK, stopTypesEnum.TRAILER_POSITION, stopTypesEnum.TRACTOR_POSITION]),
                                            key: 'appointmentFrom'
                                        }"></ng-container>
                                    </td>
                                    <td *ngIf="getBookingsColumnVisible(8)" class="col-sm-1">
                                        {{booking.vehicleType && booking.vehicleType.type}}
                                    </td>
                                </tr>
                                <ng-container *ngIf="bookingsCollapseMap[booking.id]">
                                    <ng-container *ngTemplateOutlet="stopsSubtable; context: {
                                        stops: booking.stops,
                                        leftColspan: 1, totalColspan: 9,
                                        preassigned: false, dispatched: false,
                                        entityId: booking.id,
                                        collapseMap: bookingsCollapseMap,
                                        driver: null
                                    }"></ng-container>
                                </ng-container>
                            </ng-container>
                        </tbody>
                    </table>

                    <div class="dt-toolbar-footer">
                        <div class="col-sm-6 col-xs-12 hidden-xs">
                            <div class="dataTables_info" role="status" style="padding-top: 9px; padding-bottom: 6px;">
                                Showing {{bookingsFilter.filteredBookings.length > 0 ? bookingsFilter.paginatedBookings.begin + 1 : 0}}
                                to {{bookingsFilter.paginatedBookings.end}} of {{bookingsFilter.filteredBookings.length}} entries
                            </div>
                        </div>
                        <div class="col-xs-12 col-sm-6" style="padding-top: 2px;">
                            <ngb-pagination [boundaryLinks]="false" [collectionSize]="bookingsFilter.filteredBookings.length" [(page)]="bookingsPage"
                                [pageSize]="bookingsPageSize" [maxSize]="4" [rotate]="true" [ellipses]="true" size="sm"
                                (pageChange)="changeBookingsPage($event)" aria-label="Default pagination" *ngIf="bookingsFilter.filteredBookings.length > 0"
                                class="pagination-no-margin">
                                <ng-template ngbPaginationPrevious>
                                    Previous
                                </ng-template>
                                <ng-template ngbPaginationNext>
                                    Next
                                </ng-template>
                            </ngb-pagination>
                            <div class="column-selector-menu-show-hide hidden-xs">
                                <a id="bookingsContextShowHide" class="action-link" title="Manage Columns">
                                    Manage Columns
                                </a>
                            </div>
                        </div>
                    </div>

                    <div id="columnSelectorContextBookings" #columnSelectorContextBookings class="column-selector-menu"
                        [style.left.px]="columnSelectorBookingsMenuLeft" [style.top.px]="columnSelectorBookingsMenuTop"
                        *ngIf="showColumnSelectorBookings">
                        <div class="column-selector-menu-options">
                            <span>Select Columns</span>
                            <br>
                            <ng-container *ngFor="let tableColumn of tableBookingsColumnsClone">
                                <input type="checkbox" name="list" (change)="columnSelectionChange(tableNameBookings, tableBookingsColumnsClone, tableColumn)" data-target="1"
                                    [value]="tableColumn.index" [checked]="tableColumn.visible" class="column-selector-menu-option"
                                    [disabled]="isLastColumnBookings && tableColumn.visible">
                                {{getName(tableColumn.name)}}
                                <br>
                            </ng-container>
                            <button class="btn btn-default pull-right column-select-button"
                                (click)="applyColumnSelection(tableNameBookings, tableBookingsColumnsClone)">
                                Apply
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<ng-template #stopLocation let-stop="stop" let-query="query">
    <ng-container *ngIf="!!stop && stop.isLocation()">
        <app-location-map-modal [location]="stop.location" [highlight]="query"></app-location-map-modal>
    </ng-container>
    <ng-container *ngIf="!!stop && !stop.isLocation()">
        <span ngxTextHighlight [content]="stop.address.getAddress()" [searchTerm]="query"  [caseSensitive]="false">
        </span>
    </ng-container>
</ng-template>

<ng-template #stopDate let-stop="stop" let-key="key">
    <ng-container *ngIf="!!stop">
        {{stop[key] | timezoneHandler | date : 'yyyy-MM-dd, HH:mm:ss'}}
    </ng-container>
</ng-template>

<ng-template #stopReadOnly let-stop="stop">
    <td>
        {{stop.stopOrder}}
    </td>

    <td class="col-sm-4">
        <app-location-map-modal [location]="stop.location" *ngIf="!!stop.location">
        </app-location-map-modal>
        <ng-container *ngIf="!stop.location && !!stop.address">
            <div class="form-group xsmall-form-group">
                <label class="col-sm-4">Name</label>
                <div class="col-sm-8">{{stop.name | naHandler}}</div>
            </div>
            <div class="form-group xsmall-form-group">
                <i class="col-sm-12">
                    {{stop.address.getAddress()}}
                </i>
            </div>
        </ng-container>

        <div class="form-group xsmall-form-group">
            <label class="col-sm-4">Phone</label>
            <div class="col-sm-8">{{stop.phone ? "+" + stop.phone : "N/A"}}</div>
        </div>
        <div class="form-group xsmall-form-group">
            <label class="col-sm-4">Fax</label>
            <div class="col-sm-8">{{stop.fax ? "+" + stop.fax : "N/A"}}</div>
        </div>
    </td>

    <td class="col-sm-4">
        <div class="form-group small-form-group">
            <label class="col-sm-4">App Date</label>
            <div class="col-sm-8">
                {{stop.appointmentFrom | timezoneHandler | date : 'yyyy-MM-dd, HH:mm:ss' | naHandler}}
                -
                {{stop.appointmentTo | timezoneHandler | date : 'yyyy-MM-dd, HH:mm:ss' | naHandler}}
            </div>
        </div>

        <div class="form-group small-form-group">
            <label class="col-sm-4">Load No</label>
            <div class="col-sm-8">
                {{stop.loadNo | naHandler}}
            </div>
        </div>
        <div class="form-group small-form-group">
            <label class="col-sm-4">Bol No</label>
            <div class="col-sm-8">
                {{stop.bolNo | naHandler}}
            </div>
        </div>
        <div class="form-group small-form-group">
            <label class="col-sm-4">Delv No</label>
            <div class="col-sm-8">
                {{stop.dimensions | naHandler}}
            </div>
        </div>
        <div class="form-group small-form-group">
            <label class="col-sm-4">Dimensions</label>
            <div class="col-sm-8">
                {{stop.dimensions | naHandler}}
            </div>
        </div>

        <div class="form-group small-form-group">
            <label class="col-sm-6">Value</label>
            <div class="col-sm-6">
                {{stop.cargoValue | naHandler}}
            </div>
        </div>
        <div class="form-group small-form-group">
            <label class="col-sm-6">Service Time (min)</label>
            <div class="col-sm-6">
                {{stop.plannedServiceTime | naHandler}}
            </div>
        </div>

        <label class="pull-right">
            <input [attr.checked]="stop.containsHazardousMaterials"
                style="vertical-align: -2px;" type="checkbox" disabled="true">
                Hazardous Materials
        </label>
    </td>

    <td class="col-sm-4">
        <div class="form-group small-form-group">
            <label class="col-sm-5">Stop Type</label>
            <div class="col-sm-7">
                {{stop.type | lowercase | titlecase}}
            </div>
        </div>

        <div class="form-group small-form-group">
            <label class="col-sm-5">Req. Feedback</label>
            <div class="col-sm-7">
                {{stop.getFeedbackTypesText()}}
            </div>
        </div>

        <div class="form-group small-form-group">
            <label class="col-sm-5">Sch. Arrival</label>
            <div class="col-sm-7">
                {{stop.plannedArrival | timezoneHandler | date : 'yyyy-MM-dd, HH:mm:ss' | naHandler}}
            </div>
        </div>

        <div class="form-group small-form-group">
            <label class="col-sm-5">Temperature</label>
            <div class="col-sm-7">
                {{stop.temperature | naHandler}}
            </div>
        </div>
        <br/>

        <div class="form-group small-form-group">
            <label class="col-sm-12">Description</label>
            <div class="col-sm-12">
                {{stop.description | naHandler}}
            </div>
        </div>
    </td>
    <td></td>
</ng-template>

<ng-template #stopsSubtable let-stops="stops" let-dispatched="dispatched" let-leftColspan="leftColspan"
    let-totalColspan="totalColspan" let-preassigned="preassigned" let-entityId="entityId" let-collapseMap="collapseMap"
    let-driver="driver">
    <tr>
        <th [attr.colspan]="leftColspan"></th>
        <th [class.success]="preassigned">Order</th>
        <th [class.success]="preassigned">Stop Type</th>
        <th [class.success]="preassigned">Stop Location</th>
        <th [class.success]="preassigned">Appointment</th>
        <th [class.success]="preassigned">Completed At</th>
        <th [class.success]="preassigned">Planned Arrival</th>
        <th *ngIf="totalColspan - 6 - leftColspan > 0" [attr.colspan]="totalColspan - 6 - leftColspan"></th>
    </tr>
    <ng-container *ngFor="let stop of stops | excludePositionStops as stops2Display">
        <tr>
            <td [attr.colspan]="leftColspan"></td>
            <td [class.success]="preassigned || (dispatched && !stop.reportedDepart && !stop.completedAt)">
                {{stop.stopOrder}}<a style="margin-left: 5px;"
                    (click)="collapseMap[entityId + '.' + stop.id] =
                            !collapseMap[entityId + '.' + stop.id]" class="button-icon">
                    <i class="fa" [class.fa-plus]="!collapseMap[entityId + '.' + stop.id]"
                        [class.fa-minus]="collapseMap[entityId + '.' + stop.id]">
                    </i>
                </a>
            </td>
            <td [class.success]="preassigned || (dispatched && !stop.reportedDepart && !stop.completedAt)">
                {{stop.type | lowercase | titlecase}}
            </td>
            <td [class.success]="preassigned || (dispatched && !stop.reportedDepart && !stop.completedAt)">
                <app-location-map-modal [location]="stop.location" *ngIf="!!stop.location"></app-location-map-modal>
                <label *ngIf="!stop.location && !!stop.address">
                    {{stop.address.getAddress()}}
                </label>
            </td>
            <td [class.success]="preassigned || (dispatched && !stop.reportedDepart && !stop.completedAt)">
                {{stop.appointmentFrom | timezoneHandler | date : 'yyyy-MM-dd, HH:mm:ss' | naHandler}}
                -
                {{stop.appointmentTo | timezoneHandler | date : 'yyyy-MM-dd, HH:mm:ss' | naHandler}}
            </td>
            <td [class.success]="preassigned || (dispatched && !stop.reportedDepart && !stop.completedAt)">
                {{stop.completedAt | timezoneHandler | date : 'yyyy-MM-dd, HH:mm:ss' | naHandler}}
            </td>
            <td [class.success]="preassigned || (dispatched && !stop.reportedDepart && !stop.completedAt)">
                {{stop.plannedArrival | timezoneHandler | date : 'yyyy-MM-dd, HH:mm' | naHandler}}
            </td>
            <td *ngIf="totalColspan - 6 - leftColspan > 0" [attr.colspan]="totalColspan - 6 - leftColspan"></td>
        </tr>

        <tr *ngIf="collapseMap[entityId + '.' + stop.id]">
            <td [attr.colspan]="leftColspan"></td>
            <td *ngIf="totalColspan - leftColspan" [attr.colspan]="totalColspan - leftColspan"
                style="background-color: lightyellow;">
                <div class="row">
                    <div class="col-2_5">
                        <ng-container *ngIf="stop.isLocation()">
                            <a href="#/location/list/{{stop.location.id}}/view" *ngIf="!!stop.location">
                                {{stop.location.name}}
                            </a>
                        </ng-container>
                        <ng-container *ngIf="!stop.isLocation()">
                            <b *ngIf="stop.address.name">{{stop.address.name}}<br/></b>
                            <i *ngIf="stop.address.line1">{{stop.address.line1}}<br/></i>
                            <i *ngIf="stop.address.line2">{{stop.address.line2}}<br/></i>
                            <i *ngIf="stop.address.city || stop.address.state || stop.address.zip">
                                {{[stop.address.city, stop.address.state, stop.address.zip] | join}}
                            </i>
                        </ng-container>
                        <br/><br/>

                        <div class="form-horizontal">
                            <div class="form-group xsmall-form-group">
                                <label class="col-sm-6">Load No:</label>
                                <div class="col-sm-6">{{stop.loadNo | naHandler}}</div>
                            </div>
                            <div class="form-group xsmall-form-group">
                                <label class="col-sm-6">Bol No:</label>
                                <span class="col-sm-6">{{stop.bolNo | naHandler}}</span>
                            </div>
                            <div class="form-group xsmall-form-group">
                                <label class="col-sm-6">Delv No:</label>
                                <span class="col-sm-6">{{stop.deliveryNo | naHandler}}</span>
                            </div>
                            <div class="form-group xsmall-form-group">
                                <label class="col-sm-6">Book No:</label>
                                <div class="col-sm-6">
                                    <a *ngIf="!!stop.bookingId" href="#/bookings/{{stop.bookingId}}/view">
                                        {{stop.bookNo || "(undefined)"}}
                                    </a>
                                    <ng-container *ngIf="!stop.bookingId">
                                        N/A
                                    </ng-container>
                                </div>
                            </div>
                            <div class="form-group xsmall-form-group">
                                <label class="col-sm-6">Temperature:</label>
                                <span class="col-sm-6">{{stop.temperature | naHandler}}</span>
                            </div>
                            <div class="form-group xsmall-form-group">
                                <label class="col-sm-6">Value:</label>
                                <span class="col-sm-6">{{stop.cargoValue | naHandler}}</span>
                            </div>
                            <div class="form-group xsmall-form-group">
                                <label class="col-sm-6">Dimensions:</label>
                                <span class="col-sm-6">{{stop.dimensions | naHandler}}</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-2_5">
                        <div class="form-horizontal">
                            <div class="form-group small-form-group">
                                <b class="col-sm-12">Description</b>
                                <div class="col-sm-12">{{stop.description | naHandler}}</div>
                            </div>
                            <br/>
                            <div class="form-group small-form-group">
                                <b class="col-sm-12">Notes</b>
                                <span class="col-sm-8">{{stop.notes | naHandler}}</span>
                            </div>

                            <ng-container *ngIf="isNext(stops2Display, stop, preassigned, dispatched)">
                                <br/>
                                <div class="form-group xsmall-form-group">
                                    <b class="col-sm-12">Driver's Time</b>
                                </div>
                                <app-dispatch-hos [driver]="driver">
                                </app-dispatch-hos>
                            </ng-container>
                        </div>
                    </div>

                    <ng-container *ngIf="preassigned || (dispatched && !stop.reportedDepart && !stop.completedAt); else noRouteMap">
                        <div class="col-sm-7">
                            <ng-container *ngIf="!stop.location">
                                <i class="fa-fw fa fa-warning"></i>&nbsp;
                                <i>Stop is not a defined location so no mapping can be provided</i>
                            </ng-container>
                            <app-dispatch-route *ngIf="!!stop.location" [stop]="stop" [isNext]="isNext(stops2Display, stop, preassigned, dispatched)">
                            </app-dispatch-route>
                        </div>
                    </ng-container>

                    <ng-template #noRouteMap>
                        <div class="col-sm-4">
                            <div class="form-horizontal">
                                <div class="form-group xsmall-form-group">
                                    <b class="col-sm-12">Service Time</b>
                                    <label class="col-sm-5">Reported Arrive:</label>
                                    <span class="col-sm-7">
                                        {{stop.reportedArrive | timezoneHandler | date : 'yyyy-MM-dd, HH:mm:ss' | naHandler}}
                                    </span>
                                </div>
                                <div class="form-group xsmall-form-group">
                                    <label class="col-sm-5">Reported Depart:</label>
                                    <span class="col-sm-7">
                                        {{stop.reportedDepart | timezoneHandler | date : 'yyyy-MM-dd, HH:mm:ss' | naHandler}}
                                    </span>
                                </div>
                                <div style="border-top: dashed lightgray 1px" class="form-group xsmall-form-group">
                                    <label class="col-sm-5">Reported Service:</label>
                                    <span class="col-sm-7">
                                        {{[stop.reportedDepart, stop.reportedArrive] | diffMins}}
                                    </span>
                                </div>
                                <br/>

                                <div class="form-group xsmall-form-group">
                                    <label class="col-sm-5">Observed Arrive:</label>
                                    <span class="col-sm-7">
                                        {{stop.observedArrive | timezoneHandler | date : 'yyyy-MM-dd, HH:mm:ss' | naHandler}}
                                    </span>
                                </div>
                                <div class="form-group xsmall-form-group">
                                    <label class="col-sm-5">Observed Depart:</label>
                                    <span class="col-sm-7">
                                        {{stop.observedDepart | timezoneHandler | date : 'yyyy-MM-dd, HH:mm:ss' | naHandler}}
                                    </span>
                                </div>
                                <div style="border-top: dashed lightgray 1px" class="form-group xsmall-form-group">
                                    <label class="col-sm-5">Observed Service:</label>
                                    <span class="col-sm-7">
                                        {{[stop.observedDepart, stop.observedArrive] | diffMins}}
                                    </span>
                                </div>
                                <br/>

                                <div class="form-group xsmall-form-group">
                                    <label class="col-sm-5">Planned Service:</label>
                                    <span class="col-sm-7">
                                        {{stop.plannedServiceTime ? stop.plannedServiceTime + " mins" : "N/A"}}
                                    </span>
                                </div>
                            </div>
                        </div>

                        <div class="col-sm-3">
                            <div class="form-horizontal">
                                <div class="form-group xsmall-form-group">
                                    <b class="col-sm-12">Distance</b>
                                    <label class="col-sm-7">Expected Miles:</label>
                                    <span class="col-sm-5">
                                        {{stop.expectedMiles | naHandler}}
                                    </span>
                                </div>
                                <div class="form-group xsmall-form-group">
                                    <label class="col-sm-7">Actual Miles:</label>
                                    <span class="col-sm-5">
                                        {{stop.actualMiles | naHandler}}
                                    </span>
                                </div>
                                <div style="border-top: dashed lightgray 1px" class="form-group xsmall-form-group">
                                    <label class="col-sm-7">Difference:</label>
                                    <span class="col-sm-5">
                                        <ng-container *ngIf="!!stop.expectedMiles && !!stop.actualMiles">
                                            {{stop.actualMiles - stop.expectedMiles}}
                                        </ng-container>
                                        <ng-container *ngIf="!stop.expectedMiles || !stop.actualMiles">
                                            N/A
                                        </ng-container>
                                    </span>
                                </div>
                                <br/>

                                <div class="form-group xsmall-form-group">
                                    <b class="col-sm-12">Feedback</b>
                                    <label class="col-sm-12">
                                        {{stop.getFeedbackTypesText() | naHandler}}
                                        <app-stop-feedback-modal class="pull-right" *ngIf="dispatched" [stop]="stop">
                                        </app-stop-feedback-modal>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </ng-template>
                </div>
            </td>
        </tr>
    </ng-container>
</ng-template>

<div bsModal #unassignTripModal="bs-modal" class="modal fade" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" (click)="closeUnassignTripModal()" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                <h4 class="modal-title">Unassign Trip</h4>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    Are you sure you want to unassign trip <b>{{unassignTrip.trip && unassignTrip.trip.tripNo || '(unspecified)'}}</b>
                    from <b>{{unassignTrip.entity && unassignTrip.entity.remoteId || '(unspecified)'}}</b>?
                    <br/>
                </div>
                <div class="text-right">
                    <button class="btn btn-primary" (click)="doUnassignTrip()">Unassign</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div bsModal #reassignTripModal="bs-modal" class="modal fade" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" (click)="closeReassignTripModal()" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                <h4 class="modal-title">Reassign Trip</h4>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    Are you sure you want to reassign trip <b>{{reassignTrip.trip && reassignTrip.trip.tripNo || '(unspecified)'}}</b>
                    from <b>{{reassignTrip.fromEntity && reassignTrip.fromEntity.remoteId || '(unspecified)'}}</b>
                    to <b>{{reassignTrip.toEntity && reassignTrip.toEntity.remoteId || '(unspecified)'}}</b>?
                    <br/>
                </div>
                <div class="text-right">
                    <button class="btn btn-primary" (click)="doReassignTrip()">Reassign</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div bsModal #reorderTripsModal="bs-modal" class="modal fade" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" (click)="closeReorderTripsModal()" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                <h4 class="modal-title">Reorder Trips</h4>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    Are you sure you want to reorder trips for <b>{{reorderTrips.entity && reorderTrips.entity.remoteId || '(unspecified)'}}</b>,
                    and put <b>{{reorderTrips.trip && reorderTrips.trip.tripNo || '(unspecified)'}}</b>
                    right before <b>{{reorderTrips.beforeTrip && reorderTrips.beforeTrip.tripNo || '(unspecified)'}}</b>?
                    <br/>
                </div>
                <div class="text-right">
                    <button class="btn btn-primary" (click)="doReorderTrips()">Reorder</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div bsModal #addTripModal="bs-modal" class="modal fade" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" (click)="closeTripModal()" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                <h4 class="modal-title">Create Trip & Dispatch</h4>
            </div>
            <div class="modal-body">
                <form class="form-horizontal" #addTripForm="ngForm" (ngSubmit)="isValidForm(addTripForm) && doCreateTrip()">
                    <div class="form-group small-form-group">
                        <label class="col-sm-2">Booking No</label>
                        <div class="col-sm-3">
                            <a *ngIf="!!tripData && !!tripData.booking" href="#/bookings/{{tripData.booking.id}}/view">
                                {{tripData.booking.bookNo}}
                            </a>
                            <!-- <select style="width:100%" name="bookingNo" id="bookingNo" [(ngModel)]="tripData.bookingId"
                                [disabled]="availableBookings.length === 0" *ngIf="!tripData.booking">
                                <option *ngFor="let b of availableBookings" [value]="b.id">{{b.bookNo}}</option>
                            </select>

                            <div *ngIf="!tripData.booking && availableBookings.length === 0" class="help-block">
                                <div class="small">Please create a customer
                                </div>
                            </div> -->
                        </div>
                    </div>
                    <div class="form-group small-form-group">
                        <label class="col-sm-2">Customer</label>
                        <div class="col-sm-3">
                            <a *ngIf="!!tripData && !!tripData.booking" href="#/customers/{{tripData.booking.customer.id}}/view">
                                {{tripData.booking.customer.name}}
                            </a>
                        </div>
                    </div>
                    <div class="form-group small-form-group">
                        <label class="col-sm-2">Vehicle Type</label>
                        <div class="col-sm-3">
                            <i *ngIf="!!tripData && !!tripData.booking">
                                {{tripData.booking.vehicleType && tripData.booking.vehicleType.type}}
                            </i>
                        </div>
                    </div>

                    <h6>Resources</h6>
                    <div class="form-horizontal tables-flat">
                        <table class="table table-condensed" style="width: 50%">
                            <thead>
                                <tr>
                                    <th class="col-sm-4">Type</th>
                                    <th class="col-sm-8">Resource</th>
                                    <th class="">
                                        <button class="btn btn-xs btn-success" type="button" (click)="addResource()">
                                            <i class="fa fa-plus"></i>
                                        </button>
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                <ng-container *ngIf="!!tripData && !!tripData.resources">
                                    <tr *ngFor="let resource of tripData.resources; index as order">
                                        <td class="col-sm-4">
                                            <select style="width:100%;" name="resourceType{{resource.id}}" [(ngModel)]="resource.entityType"
                                                (ngModelChange)="onTypeChange(resource, $event)" [disabled]="!resource.removable || !resource.editable">
                                                <option *ngFor="let rt of resourceTypes" [value]="rt">{{rt | lowercase | titlecase}}</option>
                                            </select>
                                        </td>
                                        <td class="col-sm-8">
                                            <ng-container *ngIf="resource.entityType === 'Vehicle'">
                                                <ng-select class="to-default" name="vehicle{{resource.id}}" id="vehicle{{resource.id}}"
                                                    [items]="applicableVehicles" bindLabel="remoteId" bindValue="id" [clearable]="false"
                                                    [(ngModel)]="resource.entityId" dropdownPosition="bottom"
                                                    [disabled]="!resource.editable || applicableVehicles.length === 0">
                                                    <ng-template ng-label-tmp let-item="item" let-clear="clear">
                                                        <div class="ng-value">
                                                            <span class="ng-value-label">{{item.remoteId}}</span>
                                                        </div>
                                                    </ng-template>
                                                    <ng-template ng-option-tmp let-item="item" let-index="index" let-search="searchTerm">
                                                        <span [ngOptionHighlight]="search">{{item.remoteId}}</span>
                                                    </ng-template>
                                                </ng-select>
                                                <!-- <select style="width: 100%;" data-select-search="true" select2 [(ngModel)]="resource.entityId"
                                                    (changedAction)="resourceChanged(resource, $event)" [chooseOnTab]="true" name="vehicle{{resource.id}}"
                                                    id="vehicle{{resource.id}}" [disabled]="!resource.editable || applicableVehicles.length === 0">
                                                    <option *ngFor="let vehicle of applicableVehicles" [value]="vehicle.id">{{vehicle.remoteId || '(unspecified)'}}</option>
                                                </select> -->

                                                <div *ngIf="applicableVehicles.length === 0" class="help-block">
                                                    <div class="small" style="color: red;">No vehicles of the specified type
                                                    </div>
                                                </div>
                                            </ng-container>

                                            <ng-container *ngIf="resource.entityType === 'Driver'">
												<ng-select class="to-default" name="driver{{resource.id}}" id="driver{{resource.id}}"
                                                    [items]="activeDrivers" bindLabel="remoteId" bindValue="id" [clearable]="false"
                                                    [(ngModel)]="resource.entityId" dropdownPosition="bottom" [disabled]="!resource.editable || activeDrivers.length === 0">
                                                    <ng-template ng-option-tmp let-item="item" let-index="index" let-search="searchTerm">
                                                        <span [ngOptionHighlight]="search">{{item.remoteId}}</span>
                                                    </ng-template>
                                                </ng-select>
                                                <!-- <select style="width: 100%;" data-select-search="true" select2 [(ngModel)]="resource.entityId"
                                                    (changedAction)="resourceChanged(resource, $event)" [chooseOnTab]="true"
                                                    name="driver{{resource.id}}" id="driver{{resource.id}}" [disabled]="!resource.editable || activeDrivers.length === 0">
                                                    <option *ngFor="let driver of activeDrivers" [value]="driver.id">{{driver.name() || '(unspecified)'}}</option>
                                                </select> -->

                                                <div *ngIf="activeDrivers.length === 0" class="help-block">
                                                    <div class="small" style="color: red;">No active drivers to select
                                                    </div>
                                                </div>
                                            </ng-container>
                                        </td>
                                        <td class="">
                                            <button class="btn btn-xs btn-default" type="button" (click)="deleteResource(order)" *ngIf="resource.removable">
                                                <i class="fa fa-minus"></i>
                                            </button>
                                            <!-- {{resource.entityType}} -->
                                        </td>
                                    </tr>
                                </ng-container>
                            </tbody>
                        </table>
                    </div>
                    <br/>

                    <h6>Stops</h6>
                    <div class="form-horizontal tables-flat">
                        <table class="table table-condensed">
                            <thead>
                                <tr>
                                    <th>Order</th>
                                    <th class="col-sm-4">Location</th>
                                    <th class="col-sm-4">Appointment Details</th>
                                    <th class="col-sm-4">Stop Details</th>
                                    <th>
                                        <button class="btn btn-xs btn-success" type="button" (click)="addStop()">
                                            <i class="fa fa-plus"></i>
                                        </button>
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                <ng-container *ngIf="!!tripData && !!tripData.bookingStops">
                                    <tr *ngFor="let stop of tripData.bookingStops">
                                        <ng-container *ngTemplateOutlet="stopReadOnly; context: {
                                            stop: stop
                                        }"></ng-container>
                                    </tr>
                                </ng-container>
                                <ng-container *ngIf="!!tripData && !!tripData.stops">
                                    <tr *ngFor="let stop of tripData.stops; index as order">
                                        <td>
                                            {{tripData.stopsBegin + order + 1}}
                                        </td>
                                        <td class="col-sm-4">
                                            <label for="isLocation{{stop.id}}" *ngIf="locations.length > 0">
                                                <input name="isLocation{{stop.id}}" id="isLocation{{stop.id}}" [(ngModel)]="stop.isLocation"
                                                    style="vertical-align: -2px;" type="checkbox">
                                                Select Location
                                            </label>

                                            <div *ngIf="stop.isLocation" class="small-form-group">
                                                <ng-select class="to-default" name="location{{stop.id}}"
                                                    [items]="locations" bindLabel="name" bindValue="id" [clearable]="false"
                                                    [(ngModel)]="stop.locationId" dropdownPosition="bottom">
                                                    <ng-template ng-option-tmp let-item="item" let-index="index" let-search="searchTerm">
                                                        <span [ngOptionHighlight]="search">{{item.name}}</span>
                                                    </ng-template>
                                                </ng-select>
                                            </div>

                                            <div *ngIf="!stop.isLocation">
                                                <div class="form-group small-form-group">
                                                    <label class="col-sm-4" for="name{{stop.id}}">Name</label>
                                                    <div class="col-sm-8">
                                                        <input class="input input-xs form-control" name="name{{stop.id}}" [(ngModel)]="stop.name">
                                                    </div>
                                                </div>
                                                <app-address-input [address]="stop.address" [prefix]="order" [compact]="true"></app-address-input>
                                            </div>

                                            <div class="form-group small-form-group">
                                                <label class="col-sm-4" for="phone{{stop.id}}">Phone</label>
                                                <div class="col-sm-8" [ngClass]="{ 'has-error': addTripForm.submitted && addTripForm.controls['phone' + stop.id] && addTripForm.controls['phone' + stop.id].invalid }">
                                                    <input class="input input-xs form-control" type='text' name="phone{{stop.id}}"
                                                        [(ngModel)]="stop.phone" prefix="+" mask="00000000009" [showMaskTyped]="true"
                                                        style="border-width: 1px;">
            
                                                    <div *ngIf="addTripForm.submitted && addTripForm.controls['phone' + stop.id] && addTripForm.controls['phone' + stop.id].invalid" class="help-block">
                                                        <div class="small" *ngIf="addTripForm.controls['phone' + stop.id] && addTripForm.controls['phone' + stop.id].invalid">Valid phone is 10-11 digits</div>
                                                    </div>
                                                </div>
                                            </div>
            
                                            <div class="form-group small-form-group">
                                                <label class="col-sm-4" for="fax{{stop.id}}">Fax</label>
                                                <div class="col-sm-8" [ngClass]="{ 'has-error': addTripForm.submitted && addTripForm.controls['fax' + stop.id] && addTripForm.controls['fax' + stop.id].invalid }">
                                                    <input class="input input-xs form-control" type='text' name="fax{{stop.id}}"
                                                        [(ngModel)]="stop.fax" prefix="+" mask="00000000009" [showMaskTyped]="true"
                                                        style="border-width: 1px;">
            
                                                    <div *ngIf="addTripForm.submitted && addTripForm.controls['fax' + stop.id] && addTripForm.controls['fax' + stop.id].invalid" class="help-block">
                                                        <div class="small" *ngIf="addTripForm.controls['fax' + stop.id] && addTripForm.controls['fax' + stop.id].invalid">Valid fax is 10-11 digits</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </td>

                                        <td class="col-sm-4">
                                            <div class="form-group small-form-group">
                                                <label class="col-sm-4" for="appointmentFrom{{stop.id}}">App Date</label>
                                                <div class="col-sm-8">
                                                    <div class="input-group" style="margin-bottom: 5px;">
                                                        <input name="appointmentFrom{{stop.id}}" class="form-control" style="height: 24px; padding-left: 4px;"
                                                            [(ngModel)]="stop.appPeriod" [owlDateTimeTrigger]="dt" [owlDateTime]="dt" [selectMode]="'range'">
                                                        <span class="input-group-addon" style="height: 24px; padding: 4.2px;">
                                                            <i class="fa fa-calendar"></i>
                                                        </span>
                                                        <owl-date-time [pickerType]="'both'" #dt></owl-date-time>
                                                    </div>
                                                </div>
                                            </div>
            
                                            <div class="form-group small-form-group">
                                                <label class="col-sm-4" for="loadNo{{stop.id}}">Load No</label>
                                                <div class="col-sm-8">
                                                    <input class="input input-xs form-control" name="loadNo{{stop.id}}" [(ngModel)]="stop.loadNo">
                                                </div>
                                            </div>
                                            <div class="form-group small-form-group">
                                                <label class="col-sm-4" for="bolNo{{stop.id}}">Bol No</label>
                                                <div class="col-sm-8">
                                                    <input class="input input-xs form-control" name="bolNo{{stop.id}}" [(ngModel)]="stop.bolNo">
                                                </div>
                                            </div>
                                            <div class="form-group small-form-group">
                                                <label class="col-sm-4" for="deliveryNo{{stop.id}}">Delv No</label>
                                                <div class="col-sm-8">
                                                    <input class="input input-xs form-control" name="deliveryNo{{stop.id}}" [(ngModel)]="stop.deliveryNo">
                                                </div>
                                            </div>
                                            <div class="form-group small-form-group">
                                                <label class="col-sm-4" for="dimensions{{stop.id}}">Dimensions</label>
                                                <div class="col-sm-8">
                                                    <input class="input input-xs form-control" name="dimensions{{stop.id}}" [(ngModel)]="stop.dimensions">
                                                </div>
                                            </div>
            
                                            <div class="form-group small-form-group">
                                                <label class="col-sm-6" for="cargoValue{{stop.id}}">Value</label>
                                                <div class="col-sm-6">
                                                    <input class="input input-xs form-control" name="cargoValue{{stop.id}}"
                                                        type="number" [(ngModel)]="stop.cargoValue">
                                                </div>
                                            </div>
                                            <div class="form-group small-form-group">
                                                <label class="col-sm-6" for="plannedServiceTime{{stop.id}}">Service Time (min)</label>
                                                <div class="col-sm-6">
                                                    <input class="input input-xs form-control" name="plannedServiceTime{{stop.id}}"
                                                        type="number" [(ngModel)]="stop.plannedServiceTime">
                                                </div>
                                            </div>
            
                                            <label for="containsHazardousMaterials{{stop.id}}" class="pull-right">
                                                <input name="containsHazardousMaterials{{stop.id}}" id="containsHazardousMaterials{{stop.id}}" [(ngModel)]="stop.containsHazardousMaterials"
                                                    style="vertical-align: -2px;" type="checkbox">
                                                    Hazardous Materials
                                            </label>
                                        </td>

                                        <td class="col-sm-4">
                                            <div class="form-group small-form-group">
                                                <label class="col-sm-5" for="type{{stop.id}}">Stop Type</label>
                                                <div class="col-sm-7">
                                                    <select style="width:100%" name="type{{stop.id}}" [(ngModel)]="stop.type">
                                                        <option *ngFor="let st of stopTypes" [value]="st">{{st | lowercase | titlecase}}</option>
                                                    </select>
                                                </div>
                                            </div>

                                            <div class="form-group small-form-group">
                                                <label class="col-sm-5" for="type{{stop.id}}">Req. Feedback</label>
                                                <div class="col-sm-7">
                                                    <label *ngIf="feedbackTypes.length === 0">
                                                        <i>No feedback types to select</i>
                                                    </label>
                                                    <ng-select class="to-default" name="feedback{{stop.id}}" *ngIf="feedbackTypes.length > 0"
                                                        [items]="feedbackTypes" bindLabel="name" bindValue="id" [closeOnSelect]="false"
                                                        [(ngModel)]="stop.requiredFeedbackTypes" [multiple]="true" dropdownPosition="bottom">
                                                        <ng-template ng-multi-label-tmp let-items="items" let-clear="clear">
                                                            <div class="ng-value">
                                                                <span class="ng-value-label" *ngIf="items.length === 1">Selected {{items.length}} type</span>
                                                                <span class="ng-value-label" *ngIf="items.length > 1">Selected {{items.length}} types</span>
                                                            </div>
                                                        </ng-template>
                                                        <ng-template ng-option-tmp let-item="item" let-index="index" let-search="searchTerm">
                                                            <span [ngOptionHighlight]="search">{{item.name}}</span>
                                                        </ng-template>
                                                    </ng-select>
                                                </div>
                                            </div>

                                            <div class="form-group small-form-group">
                                                <label class="col-sm-5" for="plannedArrival{{stop.id}}">Sch. Arrival</label>
                                                <div class="col-sm-7">
                                                    <div class="input-group" style="margin-bottom: 5px;">
                                                        <input [(ngModel)]="stop.plannedArrival" [owlDateTimeTrigger]="dtPlannedArrival" [owlDateTime]="dtPlannedArrival"
                                                            name="plannedArrival{{stop.id}}" class="form-control" style="height: 24px; padding-left: 4px;">
                                                        <span class="input-group-addon" style="height: 24px; padding: 4.2px;">
                                                            <i class="fa fa-calendar"></i>
                                                        </span>
                                                        <owl-date-time #dtPlannedArrival></owl-date-time>
                                                    </div>
                                                </div>
                                            </div>
            
                                            <div class="form-group small-form-group">
                                                <label class="col-sm-5" for="temperature{{stop.id}}">Temperature</label>
                                                <div class="col-sm-7">
                                                    <input class="input input-xs form-control" name="temperature{{stop.id}}"
                                                        type="number" [(ngModel)]="stop.temperature">
                                                </div>
                                            </div>
            
                                            <div class="form-group small-form-group">
                                                <label class="col-sm-12" for="description{{stop.id}}">Description</label>
                                                <div class="col-sm-12">
                                                    <textarea [(ngModel)]="stop.description" class="form-control"
                                                        style="resize: none;" name="description{{stop.id}}" rows="4">
                                                    </textarea>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <button class="btn btn-xs btn-default" type="button" (click)="deleteStop(order)">
                                                <i class="fa fa-minus"></i>
                                            </button>
                                        </td>
                                    </tr>
                                </ng-container>
                            </tbody>
                        </table>
                    </div>
                    <br/>

                    <div class="text-right">
                        <button class="btn btn-default" type="button" (click)="closeTripModal()">
                            Cancel
                        </button>
                        &nbsp;
                        <button class="btn btn-primary" type="submit"
                            [disabled]="applicableVehicles.length === 0 || activeDrivers.length === 0">
                            <!-- {{availableBookings.length === 0}} -->
                            Assign
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div bsModal #editTripModal="bs-modal" class="modal fade" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" (click)="closeEditTripModal()" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                <h4 class="modal-title">Edit Trip</h4>
            </div>
            <div class="modal-body">
                <form class="form-horizontal" #editTripForm="ngForm" (ngSubmit)="isValidEditForm(editTripForm) && doUpdateTrip()">
                    <div class="form-group small-form-group">
                        <label class="col-sm-2">Trip No</label>
                        <div class="col-sm-3">
                            {{editTripData.trip?.tripNo}}
                        </div>
                    </div>
                    <div class="form-group small-form-group">
                        <label class="col-sm-2">Booking No</label>
                        <div class="col-sm-3">
                            <a *ngIf="!!editTripData && !!editTripData.booking" href="#/bookings/{{editTripData.booking.id}}/view">
                                {{editTripData.booking.bookNo}}
                            </a>
                        </div>
                    </div>
                    <div class="form-group small-form-group">
                        <label class="col-sm-2">Customer</label>
                        <div class="col-sm-3">
                            <a *ngIf="!!editTripData && !!editTripData.booking" href="#/customers/{{editTripData.booking.customer.id}}/view">
                                {{editTripData.booking.customer.name}}
                            </a>
                        </div>
                    </div>
                    <div class="form-group small-form-group">
                        <label class="col-sm-2">Vehicle Type</label>
                        <div class="col-sm-3">
                            <i *ngIf="!!editTripData && !!editTripData.booking">
                                {{editTripData.booking.vehicleType && editTripData.booking.vehicleType.type}}
                            </i>
                        </div>
                    </div>

                    <h6>Resources</h6>
                    <div class="form-horizontal tables-flat">
                        <table class="table table-condensed" style="width: 50%">
                            <thead>
                                <tr>
                                    <th class="col-sm-4">Type</th>
                                    <th class="col-sm-8">Resource</th>
                                    <th class="">
                                        <button class="btn btn-xs btn-success" type="button" (click)="addEditResource()">
                                            <i class="fa fa-plus"></i>
                                        </button>
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                <ng-container *ngIf="!!editTripData && !!editTripData.resources">
                                    <tr *ngFor="let resource of editTripData.resources; index as order">
                                        <td class="col-sm-4">
                                            <select style="width:100%;" name="resourceType{{resource.id}}" [(ngModel)]="resource.entityType"
                                                (ngModelChange)="onEditTypeChange(resource, $event)">
                                                <option *ngFor="let rt of resourceTypes" [value]="rt">{{rt | lowercase | titlecase}}</option>
                                            </select>
                                        </td>
                                        <td class="col-sm-8">
                                            <ng-container *ngIf="resource.entityType === 'Vehicle'">
                                                <ng-select class="to-default" name="vehicle{{resource.id}}" id="vehicle{{resource.id}}"
                                                    [items]="applicableVehicles" bindLabel="remoteId" bindValue="id" [clearable]="false"
                                                    [(ngModel)]="resource.entityId" dropdownPosition="bottom">
                                                    <ng-template ng-label-tmp let-item="item" let-clear="clear">
                                                        <div class="ng-value">
                                                            <span class="ng-value-label">{{item.remoteId}}</span>
                                                        </div>
                                                    </ng-template>
                                                    <ng-template ng-option-tmp let-item="item" let-index="index" let-search="searchTerm">
                                                        <span [ngOptionHighlight]="search">{{item.remoteId}}</span>
                                                    </ng-template>
                                                </ng-select>

                                                <div *ngIf="applicableVehicles.length === 0" class="help-block">
                                                    <div class="small" style="color: red;">No vehicles of the specified type
                                                    </div>
                                                </div>
                                            </ng-container>

                                            <ng-container *ngIf="resource.entityType === 'Driver'">
												<ng-select class="to-default" name="driver{{resource.id}}" id="driver{{resource.id}}"
                                                    [items]="activeDrivers" bindLabel="remoteId" bindValue="id" [clearable]="false"
                                                    [(ngModel)]="resource.entityId" dropdownPosition="bottom">
                                                    <ng-template ng-option-tmp let-item="item" let-index="index" let-search="searchTerm">
                                                        <span [ngOptionHighlight]="search">{{item.remoteId}}</span>
                                                    </ng-template>
                                                </ng-select>

                                                <div *ngIf="activeDrivers.length === 0" class="help-block">
                                                    <div class="small" style="color: red;">No active drivers to select
                                                    </div>
                                                </div>
                                            </ng-container>
                                        </td>
                                        <td class="">
                                            <button class="btn btn-xs btn-default" type="button" (click)="deleteEditResource(order)">
                                                <i class="fa fa-minus"></i>
                                            </button>
                                        </td>
                                    </tr>
                                </ng-container>
                            </tbody>
                        </table>
                        <div *ngIf="editTripForm.submitted && resourcesInvalid" class="help-block">
                            <div class="small" style="color: red;">At least one Vehicle and one Driver are required</div>
                        </div>
                    </div>
                    <br/>

                    <h6>Stops</h6>
                    <div class="form-horizontal tables-flat">
                        <table class="table table-condensed" *ngVar="{
                            dispatched: editTripData.trip?.status === tripStatuses.DISPATCHED,
                            preassigned: editTripData.trip?.status === tripStatuses.PREASSIGNED
                        } as variables">
                            <thead>
                                <tr>
                                    <th>Order</th>
                                    <th class="col-sm-4">Location</th>
                                    <th class="col-sm-4">Appointment Details</th>
                                    <th class="col-sm-4">Stop Details</th>
                                    <th class="">
                                        <button class="btn btn-xs btn-success" type="button" (click)="addEditStop()">
                                            <i class="fa fa-plus"></i>
                                        </button>
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                <ng-container *ngIf="!!editTripData && !!editTripData.stops">
                                    <ng-container *ngFor="let stop of editTripData.stops; index as order">
                                        <ng-container *ngVar="{
                                            success: variables.preassigned || (variables.dispatched && !stop.reportedDepart && !stop.completedAt)
                                        } as stopVariables">
                                            <tr *ngIf="!stopVariables.success">
                                                <ng-container *ngTemplateOutlet="stopReadOnly; context: {
                                                    stop: stop.stop
                                                }"></ng-container>
                                            </tr>

                                            <tr *ngIf="stopVariables.success"
                                                droppable (onDrop)="onStopReorder(stop, $event)" [dropScope]="'stop'"
                                                draggable [dragData]="{stop: stop}" [dragScope]="'stop'"
                                                class="success">
                                                <td>
                                                    {{order + 1}}
                                                </td>
                                                <td class="col-sm-4">
                                                    <label for="isLocation{{stop.id}}" *ngIf="locations.length > 0">
                                                        <input name="isLocation{{stop.id}}" id="isLocation{{stop.id}}" [(ngModel)]="stop.isLocation"
                                                            style="vertical-align: -2px;" type="checkbox">
                                                        Select Location
                                                    </label>
        
                                                    <div *ngIf="stop.isLocation" class="small-form-group">
                                                        <ng-select class="to-default" name="location{{stop.id}}"
                                                            [items]="locations" bindLabel="name" bindValue="id" [clearable]="false"
                                                            [(ngModel)]="stop.locationId" dropdownPosition="bottom">
                                                            <ng-template ng-option-tmp let-item="item" let-index="index" let-search="searchTerm">
                                                                <span [ngOptionHighlight]="search">{{item.name}}</span>
                                                            </ng-template>
                                                        </ng-select>
                                                    </div>
        
                                                    <div *ngIf="!stop.isLocation">
                                                        <div class="form-group small-form-group">
                                                            <label class="col-sm-4" for="name{{stop.id}}">Name</label>
                                                            <div class="col-sm-8">
                                                                <input class="input input-xs form-control" name="name{{stop.id}}" [(ngModel)]="stop.name">
                                                            </div>
                                                        </div>
                                                        <app-address-input [address]="stop.address" [prefix]="order" [compact]="true"></app-address-input>
                                                    </div>
        
                                                    <div class="form-group small-form-group">
                                                        <label class="col-sm-4" for="phone{{stop.id}}">Phone</label>
                                                        <div class="col-sm-8" [ngClass]="{ 'has-error': editTripForm.submitted && editTripForm.controls['phone' + stop.id] && editTripForm.controls['phone' + stop.id].invalid }">
                                                            <input class="input input-xs form-control" type='text' name="phone{{stop.id}}"
                                                                [(ngModel)]="stop.phone" prefix="+" mask="00000000009" [showMaskTyped]="true"
                                                                style="border-width: 1px;">
                    
                                                            <div *ngIf="editTripForm.submitted && editTripForm.controls['phone' + stop.id] && editTripForm.controls['phone' + stop.id].invalid" class="help-block">
                                                                <div class="small" *ngIf="editTripForm.controls['phone' + stop.id] && editTripForm.controls['phone' + stop.id].invalid">Valid phone is 10-11 digits</div>
                                                            </div>
                                                        </div>
                                                    </div>
                    
                                                    <div class="form-group small-form-group">
                                                        <label class="col-sm-4" for="fax{{stop.id}}">Fax</label>
                                                        <div class="col-sm-8" [ngClass]="{ 'has-error': editTripForm.submitted && editTripForm.controls['fax' + stop.id] && editTripForm.controls['fax' + stop.id].invalid }">
                                                            <input class="input input-xs form-control" type='text' name="fax{{stop.id}}"
                                                                [(ngModel)]="stop.fax" prefix="+" mask="00000000009" [showMaskTyped]="true"
                                                                style="border-width: 1px;">
                    
                                                            <div *ngIf="editTripForm.submitted && editTripForm.controls['fax' + stop.id] && editTripForm.controls['fax' + stop.id].invalid" class="help-block">
                                                                <div class="small" *ngIf="editTripForm.controls['fax' + stop.id] && editTripForm.controls['fax' + stop.id].invalid">Valid fax is 10-11 digits</div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </td>
        
                                                <td class="col-sm-4">
                                                    <div class="form-group small-form-group">
                                                        <label class="col-sm-4" for="appointmentFrom{{stop.id}}">App Date</label>
                                                        <div class="col-sm-8">
                                                            <div class="input-group" style="margin-bottom: 5px;">
                                                                <input name="appointmentFrom{{stop.id}}" class="form-control" style="height: 24px; padding-left: 4px;"
                                                                    [(ngModel)]="stop.appPeriod" [owlDateTimeTrigger]="dt" [owlDateTime]="dt" [selectMode]="'range'">
                                                                <span class="input-group-addon" style="height: 24px; padding: 4.2px;">
                                                                    <i class="fa fa-calendar"></i>
                                                                </span>
                                                                <owl-date-time [pickerType]="'both'" #dt></owl-date-time>
                                                            </div>
                                                        </div>
                                                    </div>
                    
                                                    <div class="form-group small-form-group">
                                                        <label class="col-sm-4" for="loadNo{{stop.id}}">Load No</label>
                                                        <div class="col-sm-8">
                                                            <input class="input input-xs form-control" name="loadNo{{stop.id}}" [(ngModel)]="stop.loadNo">
                                                        </div>
                                                    </div>
                                                    <div class="form-group small-form-group">
                                                        <label class="col-sm-4" for="bolNo{{stop.id}}">Bol No</label>
                                                        <div class="col-sm-8">
                                                            <input class="input input-xs form-control" name="bolNo{{stop.id}}" [(ngModel)]="stop.bolNo">
                                                        </div>
                                                    </div>
                                                    <div class="form-group small-form-group">
                                                        <label class="col-sm-4" for="deliveryNo{{stop.id}}">Delv No</label>
                                                        <div class="col-sm-8">
                                                            <input class="input input-xs form-control" name="deliveryNo{{stop.id}}" [(ngModel)]="stop.deliveryNo">
                                                        </div>
                                                    </div>
                                                    <div class="form-group small-form-group">
                                                        <label class="col-sm-4" for="dimensions{{stop.id}}">Dimensions</label>
                                                        <div class="col-sm-8">
                                                            <input class="input input-xs form-control" name="dimensions{{stop.id}}" [(ngModel)]="stop.dimensions">
                                                        </div>
                                                    </div>
                    
                                                    <div class="form-group small-form-group">
                                                        <label class="col-sm-6" for="cargoValue{{stop.id}}">Value</label>
                                                        <div class="col-sm-6">
                                                            <input class="input input-xs form-control" name="cargoValue{{stop.id}}"
                                                                type="number" [(ngModel)]="stop.cargoValue">
                                                        </div>
                                                    </div>
                                                    <div class="form-group small-form-group">
                                                        <label class="col-sm-6" for="plannedServiceTime{{stop.id}}">Service Time (min)</label>
                                                        <div class="col-sm-6">
                                                            <input class="input input-xs form-control" name="plannedServiceTime{{stop.id}}"
                                                                type="number" [(ngModel)]="stop.plannedServiceTime">
                                                        </div>
                                                    </div>
                    
                                                    <label for="containsHazardousMaterials{{stop.id}}" class="pull-right">
                                                        <input name="containsHazardousMaterials{{stop.id}}" id="containsHazardousMaterials{{stop.id}}" [(ngModel)]="stop.containsHazardousMaterials"
                                                            style="vertical-align: -2px;" type="checkbox">
                                                            Hazardous Materials
                                                    </label>
                                                </td>
        
                                                <td class="col-sm-4">
                                                    <div class="form-group small-form-group">
                                                        <label class="col-sm-5" for="type{{stop.id}}">Stop Type</label>
                                                        <div class="col-sm-7">
                                                            <select style="width:100%" name="type{{stop.id}}" [(ngModel)]="stop.type">
                                                                <option *ngFor="let st of stopTypes" [value]="st">{{st | lowercase | titlecase}}</option>
                                                            </select>
                                                        </div>
                                                    </div>
        
                                                    <div class="form-group small-form-group">
                                                        <label class="col-sm-5" for="type{{stop.id}}">Req. Feedback</label>
                                                        <div class="col-sm-7">
                                                            <label *ngIf="feedbackTypes.length === 0">
                                                                <i>No feedback types to select</i>
                                                            </label>
                                                            <ng-select class="to-default" name="feedback{{stop.id}}" *ngIf="feedbackTypes.length > 0"
                                                                [items]="feedbackTypes" bindLabel="name" bindValue="id" [closeOnSelect]="false"
                                                                [(ngModel)]="stop.requiredFeedbackTypes" [multiple]="true" dropdownPosition="bottom">
                                                                <ng-template ng-multi-label-tmp let-items="items" let-clear="clear">
                                                                    <div class="ng-value">
                                                                        <span class="ng-value-label" *ngIf="items.length === 1">Selected {{items.length}} type</span>
                                                                        <span class="ng-value-label" *ngIf="items.length > 1">Selected {{items.length}} types</span>
                                                                    </div>
                                                                </ng-template>
                                                                <ng-template ng-option-tmp let-item="item" let-index="index" let-search="searchTerm">
                                                                    <span [ngOptionHighlight]="search">{{item.name}}</span>
                                                                </ng-template>
                                                            </ng-select>
                                                        </div>
                                                    </div>
        
                                                    <div class="form-group small-form-group">
                                                        <label class="col-sm-5" for="plannedArrival{{stop.id}}">Sch. Arrival</label>
                                                        <div class="col-sm-7">
                                                            <div class="input-group" style="margin-bottom: 5px;">
                                                                <input [(ngModel)]="stop.plannedArrival" [owlDateTimeTrigger]="dtPlannedArrival" [owlDateTime]="dtPlannedArrival"
                                                                    name="plannedArrival{{stop.id}}" class="form-control" style="height: 24px; padding-left: 4px;">
                                                                <span class="input-group-addon" style="height: 24px; padding: 4.2px;">
                                                                    <i class="fa fa-calendar"></i>
                                                                </span>
                                                                <owl-date-time #dtPlannedArrival></owl-date-time>
                                                            </div>
                                                        </div>
                                                    </div>
                    
                                                    <div class="form-group small-form-group">
                                                        <label class="col-sm-5" for="temperature{{stop.id}}">Temperature</label>
                                                        <div class="col-sm-7">
                                                            <input class="input input-xs form-control" name="temperature{{stop.id}}"
                                                                type="number" [(ngModel)]="stop.temperature">
                                                        </div>
                                                    </div>
                    
                                                    <div class="form-group small-form-group">
                                                        <label class="col-sm-12" for="description{{stop.id}}">Description</label>
                                                        <div class="col-sm-12">
                                                            <textarea [(ngModel)]="stop.description" class="form-control"
                                                                style="resize: none;" name="description{{stop.id}}" rows="4">
                                                            </textarea>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td>
                                                    <button class="btn btn-xs btn-default" type="button" (click)="deleteEditStop(order)">
                                                        <i class="fa fa-minus"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        </ng-container>
                                    </ng-container>
                                </ng-container>
                            </tbody>
                        </table>
                    </div>
                    <br/>

                    <div class="text-right">
                        <button class="btn btn-default" type="button" (click)="closeEditTripModal()">
                            Cancel
                        </button>
                        &nbsp;
                        <button class="btn btn-primary" type="submit"
                            [disabled]="applicableVehicles.length === 0 || activeDrivers.length === 0">
                            Save
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
